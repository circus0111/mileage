<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM é ˜èˆªå“¡ï¼šé‡Œç¨‹æµæ°´å¸³ (å« LINE POINTS)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
      :root { --primary: #5D8AA8; --secondary: #88B04B; --danger: #E07A5F; --uni: #FF8C00; --bg: #F4F7F6; --card: #FFFFFF; --text: #2C3E50; --sub: #7F8C8D; }
      body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 80px 15px; }
      .container { max-width: 900px; margin: 0 auto; }
      .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      h2 { font-size: 1.1em; border-left: 4px solid var(--primary); padding-left: 10px; margin: 0 0 15px 0; }
      .monitor-card { border: 1px solid #D1E1EB; background: #F0F7FA; position: sticky; top: 0; z-index: 10; }
      .stat-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.85em; }
      .progress-container { background: #E0E0E0; border-radius: 10px; height: 10px; margin: 8px 0; overflow: hidden; }
      .progress-bar { height: 100%; transition: width 0.6s; background: var(--primary); }
      .brand-chips { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
      .chip { font-size: 0.65em; padding: 3px 8px; border-radius: 12px; background: #EEE; color: #999; border: 1px solid #DDD; }
      .chip.active { background: var(--uni); color: white; border-color: var(--uni); font-weight: bold; }
      .form-row { display: flex; flex-direction: column; margin-bottom: 12px; }
      label { font-size: 0.8em; color: var(--sub); margin-bottom: 4px; }
      input, select { padding: 10px; border: 1px solid #DDD; border-radius: 8px; font-size: 1em; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .btn-main { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; background: var(--primary); color: white; font-weight: bold; }
      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 0.85em; min-width: 400px; }
      th, td { padding: 12px 8px; border-bottom: 1px solid #EEE; text-align: left; }
      .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
      .nav-item { text-align: center; font-size: 0.8em; cursor: pointer; color: var(--sub); flex: 1; }
      .nav-item.active { color: var(--primary); font-weight: bold; }
      .hidden { display: none; }
      .reward-tag { font-size: 0.8em; padding: 2px 5px; border-radius: 4px; background: #f0f0f0; margin-top: 2px; display: inline-block; }
      .ledger-manual { color: #88B04B; font-weight: bold; }
      .ledger-auto { color: #5D8AA8; }
  </style>
</head>
<body>

<div class="container">
  <div class="card monitor-card">
      <div class="stat-box">
          <span style="font-weight:bold;">âœˆï¸ <span id="goalNameDisp">é‡Œç¨‹ç›®æ¨™</span></span>
          <span style="color:var(--primary); font-weight:bold;"><span id="currentMilesDisp">0</span> / <span id="targetMilesDisp">0</span> AM</span>
      </div>
      <div class="progress-container"><div id="goalBar" class="progress-bar" style="background:var(--secondary);"></div></div>

      <div class="stat-box"><span>ğŸ’³ æ˜Ÿå±• 10% (ä¸Šé™ $11,363)</span><span>$<span id="dbsSpentDisp">0</span></span></div>
      <div class="progress-container"><div id="dbsBar" class="progress-bar"></div></div>

      <div class="stat-box" style="color:var(--uni); font-weight:bold;"><span>ğŸ¦ Uniopen ä»»å‹™ ($12,500)</span><span id="uniStatus">0 å“ç‰Œ</span></div>
      <div class="progress-container"><div id="uniBar" class="progress-bar" style="background:var(--uni);"></div></div>

      <div class="brand-chips" id="brandChips">
          <span class="chip" data-brand="711">7-11</span><span class="chip" data-brand="starbucks">æ˜Ÿå·´å…‹</span>
          <span class="chip" data-brand="carrefour">å®¶æ¨‚ç¦</span><span class="chip" data-brand="cosmed">åº·æ˜¯ç¾</span><span class="chip" data-brand="others">å…¶ä»–çµ±ä¸€</span>
      </div>
  </div>

  <div id="sec-entry" class="section">
      <div class="card">
          <h2>æ–°å¢æ¶ˆè²»</h2>
          <div class="grid-2"><div class="form-row"><label>æ—¥æœŸ</label><input type="date" id="txDate"></div><div class="form-row"><label>åˆ†é¡</label><select id="txCat"><option>é¤é£²ç¾é£Ÿ</option><option>äº¤é€šå‡ºè¡Œ</option><option>è³¼ç‰©æ¶ˆè²»</option><option>å±…å®¶ç”Ÿæ´»</option><option>ä¼‘é–’å¨›æ¨‚</option><option>å…¶ä»–</option></select></div></div>
          <div class="form-row"><label>é …ç›®åç¨±</label><input type="text" id="txDesc" placeholder="ä¾‹å¦‚ï¼šçµ±ä¸€è¶…å•†"></div>
          <div class="grid-2">
              <div class="form-row"><label>é‡‘é¡</label><input type="number" id="txAmt" oninput="recalc()"></div>
              <div class="form-row"><label>å¡ç‰‡</label><select id="txCard" onchange="recalc()"><option value="UNIOPEN">ä¸­ä¿¡ Uniopen</option><option value="DBS">æ˜Ÿå±•å‚³èªªå°æ±º</option><option value="CUBE_L3">åœ‹æ³° CUBE</option><option value="OTHER">å…¶ä»–</option></select></div>
          </div>
          <div class="grid-2">
              <div class="form-row"><label>æ”¯ä»˜æ–¹å¼</label><select id="txMethod" onchange="recalc()"><option value="PHYSICAL">å¯¦é«”/æ„Ÿæ‡‰</option><option value="ICASH_PAY">icash Pay (+4%)</option></select></div>
              <div class="form-row"><label>çµ±ä¸€å“ç‰Œ</label><select id="txBrand" onchange="recalc()"><option value="NONE">éçµ±ä¸€</option><option value="711">7-11</option><option value="starbucks">æ˜Ÿå·´å…‹</option><option value="carrefour">å®¶æ¨‚ç¦</option><option value="cosmed">åº·æ˜¯ç¾</option><option value="others">å…¶ä»–çµ±ä¸€</option></select></div>
          </div>
          <div id="prePreview" style="background:#F9F9F9; padding:12px; border-radius:8px; font-size:0.95em; margin-top:10px; border:1px dashed #DDD; color: var(--text);">
              é è¨ˆå›é¥‹ï¼š<span id="preTotal" style="font-weight:bold; color:var(--primary);">0</span>
          </div>
          <button onclick="commitTx()" class="btn-main" style="margin-top:15px;">ç¢ºèªè¨˜å¸³</button>
      </div>
  </div>

  <div id="sec-miles" class="section hidden">
      <div class="card"><h2>é»æ•¸è³‡ç”¢åº«å­˜ (AM æ›ç®—)</h2><div id="assetSummary"></div></div>
      <div class="card">
          <h2>æ‰‹å‹•èª¿æ•´é»æ•¸</h2>
          <div class="grid-2">
              <select id="adjType">
                  <option value="AM">AM å¯¦é«”é‡Œç¨‹</option>
                  <option value="DBS_PT">æ˜Ÿå±•é»æ•¸</option>
                  <option value="OPEN_PT">OpenPoint</option>
                  <option value="LINE_PT">LINE POINTS</option>
                  <option value="HAMI_PT">HamiPoint</option>
                  <option value="HG_PT">HappyGo</option>
                  <option value="CUBE_PT">å°æ¨¹é»</option>
                  <option value="TS_PT">å°æ–°é»</option>
              </select>
              <input type="number" id="adjVal" placeholder="+/- é»æ•¸">
          </div>
          <div class="form-row" style="margin-top:10px;">
              <label>èª¿æ•´åŸå›  / ä¾†æº</label>
              <input type="text" id="adjReason" placeholder="ä¾‹å¦‚ï¼šéæœŸæ‰£é»ã€æ´»å‹•è´ˆé»ã€é¦–åˆ·ç¦®">
          </div>
          <button onclick="commitAdj()" class="btn-main" style="background:var(--secondary); margin-top:10px;">ç¢ºèªèª¿æ•´</button>
      </div>
      <div class="card">
          <h2>é»æ•¸æµæ°´å¸³æ­·å²</h2>
          <div class="table-wrapper">
              <table id="ledgerTable">
                  <thead><tr><th>æ—¥æœŸ</th><th>åŸå› /ä¾†æº</th><th>é»æ•¸è®Šå‹•</th><th>æ›ç®— AM</th><th>åˆª</th></tr></thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>

  <div id="sec-history" class="section hidden">
      <div class="card">
          <h2>æ­·å²ç´€éŒ„</h2>
          <div class="grid-2">
              <button onclick="exportExcel()" style="background:#2ecc71; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">åŒ¯å‡º</button>
              <button onclick="document.getElementById('importFile').click()" style="background:#3498db; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">åŒ¯å…¥</button>
              <input type="file" id="importFile" style="display:none;" onchange="importExcel(event)">
          </div>
          <div class="table-wrapper" style="margin-top:20px;">
              <table id="txTable">
                  <thead><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>é‡‘é¡/é¡å‹</th><th>é è¨ˆå›é¥‹</th><th>åˆª</th></tr></thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
  </div>

  <div id="sec-settings" class="section hidden">
      <div class="card">
          <h2>æ¶ˆè²»ä½”æ¯”åˆ†æ</h2>
          <div style="max-height: 250px;"><canvas id="statChart"></canvas></div>
      </div>
      <div class="card">
          <h2>æ¯”ä¾‹èˆ‡ç›®æ¨™è¨­å®š</h2>
          <div class="grid-2"><input type="text" id="setGoalName" placeholder="ç›®æ¨™åç¨±"><input type="number" id="setGoalTarget" placeholder="ç›®æ¨™é‡‘é¡"></div>
          <div id="rateInputs" class="grid-2" style="margin-top:10px;"></div>
          <button onclick="saveSettings()" class="btn-main" style="margin-top:15px;">å„²å­˜æ¯”ä¾‹è¨­å®š</button>
      </div>
      <button onclick="clearAll()" style="width:100%; color:var(--danger); background:none; border:1px solid var(--danger); padding:10px; border-radius:8px; cursor:pointer;">é‡ç½®è³‡æ–™</button>
  </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="nav('entry')">è¨˜å¸³</div>
  <div class="nav-item" onclick="nav('miles')">é‡Œç¨‹</div>
  <div class="nav-item" onclick="nav('history')">æ­·å²</div>
  <div class="nav-item" onclick="nav('settings')">è¨­å®š</div>
</div>

<script>
  // æ›´æ–°ç‰ˆæœ¬è™Ÿç‚º v12
  let state = JSON.parse(localStorage.getItem('am_uni_v12')) || {
      records: [], adjusts: [], goal: { name: "é‡Œç¨‹ç›®æ¨™", target: 50000 },
      rates: { AM: 1, DBS_PT: 2, OPEN_PT: 0.25, LINE_PT: 0.2, HAMI_PT: 0.33, HG_PT: 0.25, CUBE_PT: 0.36, TS_PT: 0.55 }
  };

  function getMonthStats() {
      const m = new Date().getMonth();
      const mRecs = state.records.filter(r => new Date(r.date).getMonth() === m);
      const brands = new Set(mRecs.filter(r => r.brand !== 'NONE').map(r => r.brand));
      return { brandCount: brands.size, brands: Array.from(brands),
               dbsSpent: mRecs.filter(r => r.cardKey === 'DBS').reduce((sum, r) => sum + r.amt, 0),
               uniSpent: mRecs.filter(r => r.cardKey === 'UNIOPEN').reduce((sum, r) => sum + r.amt, 0) };
  }

  function calculateRowReward(r, s) {
      let ptAmount = 0; let ptName = ""; let ptKey = "";
      if(r.cardKey === 'DBS') {
          ptAmount = Math.round(r.amt * (r.amt <= 11363 ? 0.1 : 0.012));
          ptName = "DBS"; ptKey = "DBS_PT";
      } else if(r.cardKey === 'UNIOPEN') {
          let rate = (s.brandCount >= 5 ? 0.07 : 0.03) + (r.method === 'ICASH_PAY' ? 0.04 : 0);
          ptAmount = Math.round(r.amt * rate);
          ptName = "OP"; ptKey = "OPEN_PT";
      } else if(r.cardKey === 'CUBE_L3') {
          ptAmount = Math.round(r.amt * 0.03);
          ptName = "å°æ¨¹"; ptKey = "CUBE_PT";
      }
      return { ptAmount, ptName, ptKey, amTotal: Math.round(ptAmount * (state.rates[ptKey] || 0)) };
  }

  function refreshUI() {
      const s = getMonthStats();
      let totalAM = state.adjusts.reduce((sum, a) => sum + (parseFloat(a.amt) * (state.rates[a.type] || 0)), 0);
      state.records.forEach(r => { totalAM += calculateRowReward(r, s).amTotal; });

      document.getElementById('currentMilesDisp').innerText = Math.round(totalAM).toLocaleString();
      document.getElementById('targetMilesDisp').innerText = state.goal.target.toLocaleString();
      document.getElementById('goalBar').style.width = Math.min(100, (totalAM/state.goal.target)*100) + "%";
      document.getElementById('dbsSpentDisp').innerText = Math.round(s.dbsSpent).toLocaleString();
      document.getElementById('dbsBar').style.width = Math.min(100, (s.dbsSpent/11363)*100) + "%";
      document.getElementById('uniStatus').innerText = `${s.brandCount} å“ç‰Œ`;
      document.getElementById('uniBar').style.width = Math.min(100, (s.uniSpent/12500)*100) + "%";
      document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', s.brands.includes(c.dataset.brand)));

      renderAsset();
      renderHistory(s);
      renderLedger(s);
  }

  function renderLedger(s) {
      let ledger = state.adjusts.map(a => ({ ...a, isManual: true }));
      state.records.forEach(r => {
          const reward = calculateRowReward(r, s);
          if(reward.ptAmount > 0) {
              ledger.push({ id: r.id, date: r.date, type: reward.ptKey, amt: reward.ptAmount, reason: r.desc, isManual: false, am: reward.amTotal });
          }
      });
      ledger.sort((a,b) => new Date(b.date) - new Date(a.date));

      document.querySelector('#ledgerTable tbody').innerHTML = ledger.map(l => `
          <tr>
              <td><small>${l.date.slice(5)}</small></td>
              <td>${l.isManual ? '<span class="ledger-manual">[èª¿]</span>' : '<span class="ledger-auto">[è²»]</span>'} ${l.reason}</td>
              <td>${l.amt > 0 ? '+' : ''}${l.amt} ${l.type.replace('_PT','')}</td>
              <td style="color:var(--primary); font-weight:bold;">${Math.round(l.isManual ? l.amt * (state.rates[l.type]||0) : l.am)}</td>
              <td>${l.isManual ? `<button onclick="delAdj(${l.id})" style="border:none; background:none; color:red;">âŒ</button>` : ''}</td>
          </tr>
      `).join('');
  }

  function renderHistory(s) {
      document.querySelector('#txTable tbody').innerHTML = state.records.map(r => {
          const reward = calculateRowReward(r, s);
          return `<tr>
              <td>${r.date.slice(5)}</td>
              <td>${r.desc}</td>
              <td>$${r.amt.toLocaleString()}<br><small>${r.cardKey}</small></td>
              <td><span class="reward-tag">${reward.ptAmount} ${reward.ptName}</span><br><span style="color:var(--primary); font-weight:bold;">${reward.amTotal} AM</span></td>
              <td><button onclick="delRec(${r.id})" style="border:none; background:none; color:red;">âŒ</button></td>
          </tr>`;
      }).join('');
  }

  function renderAsset() {
      document.getElementById('assetSummary').innerHTML = Object.entries(state.rates).map(([k,v]) => {
          let fromAdj = state.adjusts.filter(a=>a.type===k).reduce((sum,a)=>sum+parseFloat(a.amt), 0);
          const s = getMonthStats();
          let fromRec = state.records.reduce((sum, r) => {
              const rw = calculateRowReward(r, s);
              return rw.ptKey === k ? sum + rw.ptAmount : sum;
          }, 0);
          let count = fromAdj + fromRec;
          return `<div class="stat-box" style="border-bottom:1px solid #EEE; padding:5px 0;"><span>${k.replace('_PT','')}</span><span>${Math.round(count).toLocaleString()} (â‰ˆ${Math.round(count*v).toLocaleString()} AM)</span></div>`;
      }).join('');
  }

  function recalc() {
      const amt = parseFloat(document.getElementById('txAmt').value) || 0;
      const card = document.getElementById('txCard').value;
      const s = getMonthStats();
      const tempRec = { amt, cardKey: card, method: document.getElementById('txMethod').value, brand: document.getElementById('txBrand').value };
      const reward = calculateRowReward(tempRec, s);
      document.getElementById('preTotal').innerHTML = reward.ptAmount ? `${reward.ptAmount} ${reward.ptName} <span style="color:var(--sub); margin:0 5px;">/</span> ${reward.amTotal} AM` : "0";
  }

  function commitTx() {
      const amt = parseFloat(document.getElementById('txAmt').value);
      if(!amt) return alert("è«‹è¼¸å…¥é‡‘é¡");
      state.records.unshift({ id: Date.now(), date: document.getElementById('txDate').value, cat: document.getElementById('txCat').value, desc: document.getElementById('txDesc').value, amt, cardKey: document.getElementById('txCard').value, method: document.getElementById('txMethod').value, brand: document.getElementById('txBrand').value });
      save();
  }

  function commitAdj() {
      const val = parseFloat(document.getElementById('adjVal').value);
      const reason = document.getElementById('adjReason').value || "æ‰‹å‹•èª¿æ•´";
      if(!val) return alert("è«‹è¼¸å…¥é»æ•¸");
      state.adjusts.unshift({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: document.getElementById('adjType').value, amt: val, reason: reason });
      document.getElementById('adjVal').value = "";
      document.getElementById('adjReason').value = "";
      save();
  }

  function saveSettings() {
      state.goal.name = document.getElementById('setGoalName').value || "é‡Œç¨‹ç›®æ¨™";
      state.goal.target = parseInt(document.getElementById('setGoalTarget').value) || 50000;
      Object.keys(state.rates).forEach(k => { state.rates[k] = parseFloat(document.getElementById('rate_'+k).value); });
      save(); alert("æ¯”ä¾‹å·²æ›´æ–°");
  }

  function nav(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.getElementById('sec-' + id).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      event.currentTarget.classList.add('active');
      if(id==='settings') renderChart();
  }

  function renderChart() {
      const ctx = document.getElementById('statChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      const cats = ["é¤é£²ç¾é£Ÿ","äº¤é€šå‡ºè¡Œ","è³¼ç‰©æ¶ˆè²»","å±…å®¶ç”Ÿæ´»","ä¼‘é–’å¨›æ¨‚","å…¶ä»–"];
      const data = cats.map(c => state.records.reduce((sum, r) => r.cat===c?sum+r.amt:sum, 0));
      window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: cats, datasets: [{ data, backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } } } });
  }

  function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(state.records);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Records");
      XLSX.writeFile(wb, "mileage_backup.xlsx");
  }

  function importExcel(e) {
      const reader = new FileReader();
      reader.onload = (f) => {
          state.records = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(f.target.result), {type: 'array'}).Sheets["Records"]);
          save(); location.reload();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
  }

  function save() { localStorage.setItem('am_uni_v12', JSON.stringify(state)); refreshUI(); }
  function delRec(id) { if(confirm("åˆªé™¤æ­¤æ¶ˆè²»ï¼Ÿå›é¥‹ä¹ŸæœƒåŒæ­¥æ‰£é™¤")) { state.records = state.records.filter(r=>r.id!==id); save(); } }
  function delAdj(id) { if(confirm("åˆªé™¤æ­¤èª¿æ•´ç´€éŒ„ï¼Ÿ")) { state.adjusts = state.adjusts.filter(a=>a.id!==id); save(); } }
  function clearAll() { if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

  document.getElementById('txDate').valueAsDate = new Date();
  document.getElementById('setGoalName').value = state.goal.name;
  document.getElementById('setGoalTarget').value = state.goal.target;
  document.getElementById('rateInputs').innerHTML = Object.keys(state.rates).map(k => `<div class="form-row"><label>${k.replace('_PT','')} æ¯”ä¾‹</label><input type="number" step="0.01" id="rate_${k}" value="${state.rates[k]}"></div>`).join('');
  refreshUI();
</script>
</body>
</html>

