<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>AM é ˜èˆªå“¡ x Uniopenï¼šçµ‚æ¥µç›£è¦–ç‰ˆ</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
   <style>
       :root { --primary: #5D8AA8; --secondary: #88B04B; --danger: #E07A5F; --uni: #FF8C00; --bg: #F4F7F6; --card: #FFFFFF; --text: #2C3E50; --sub: #7F8C8D; }
       body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 80px 15px; }
       .container { max-width: 900px; margin: 0 auto; }
       .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
       h2 { font-size: 1.1em; border-left: 4px solid var(--primary); padding-left: 10px; margin: 0 0 15px 0; }
       .monitor-card { border: 1px solid #D1E1EB; background: #F0F7FA; position: sticky; top: 0; z-index: 10; }
       .stat-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.85em; }
       .progress-container { background: #E0E0E0; border-radius: 10px; height: 8px; margin-bottom: 8px; overflow: hidden; }
       .progress-bar { height: 100%; transition: width 0.5s; background: var(--primary); }
       .brand-chips { display: flex; gap: 4px; margin-top: 5px; flex-wrap: wrap; }
       .chip { font-size: 0.65em; padding: 2px 6px; border-radius: 10px; background: #EEE; color: #999; border: 1px solid #DDD; }
       .chip.active { background: var(--uni); color: white; border-color: var(--uni); font-weight: bold; }
       .form-row { display: flex; flex-direction: column; margin-bottom: 12px; }
       label { font-size: 0.8em; color: var(--sub); margin-bottom: 4px; }
       input, select { padding: 10px; border: 1px solid #DDD; border-radius: 8px; font-size: 1em; }
       .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
       .btn-main { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; background: var(--primary); color: white; margin-top: 5px; }
       .table-wrapper { overflow-x: auto; }
       table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
       th, td { padding: 10px 8px; border-bottom: 1px solid #EEE; text-align: left; }
       .tag { font-size: 0.75em; padding: 2px 4px; border-radius: 4px; background: #EEE; margin-right: 3px; }
       .reward-op { color: var(--uni); font-weight: bold; }
       .reward-am { color: var(--primary); font-weight: bold; }
       .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
       .nav-item { text-align: center; font-size: 0.75em; cursor: pointer; color: var(--sub); flex: 1; }
       .nav-item.active { color: var(--primary); font-weight: bold; }
       .hidden { display: none; }
   </style>
</head>
<body>

<div class="container">
   <div class="card monitor-card">
       <div class="stat-box"><span>âœˆï¸ <span id="goalNameDisp">é‡Œç¨‹ç›®æ¨™</span></span><span><span id="currentMilesDisp">0</span> / <span id="targetMilesDisp">0</span> AM</span></div>
       <div class="progress-container"><div id="goalBar" class="progress-bar" style="background:var(--secondary);"></div></div>
       <div class="stat-box"><span>ğŸ’³ æ˜Ÿå±• 10% (ä¸Šé™ $11,363)</span><span>$<span id="dbsSpentDisp">0</span></span></div>
       <div class="progress-container"><div id="dbsBar" class="progress-bar"></div></div>
       <div class="stat-box" style="color:var(--uni); font-weight:bold;"><span>ğŸ¦ Uniopen ä»»å‹™ ($12,500)</span><span id="uniStatus">0 å“ç‰Œ (3%)</span></div>
       <div class="progress-container"><div id="uniBar" class="progress-bar" style="background:var(--uni);"></div></div>
       <div class="brand-chips" id="brandChips">
           <span class="chip" data-brand="711">7-11</span><span class="chip" data-brand="starbucks">æ˜Ÿå·´å…‹</span>
           <span class="chip" data-brand="carrefour">å®¶æ¨‚ç¦</span><span class="chip" data-brand="cosmed">åº·æ˜¯ç¾</span><span class="chip" data-brand="others">å…¶ä»–çµ±ä¸€</span>
       </div>
   </div>

   <div id="sec-entry" class="section">
       <div class="card">
           <h2>æ–°å¢æ¶ˆè²»</h2>
           <div class="grid-2"><div class="form-row"><label>æ—¥æœŸ</label><input type="date" id="txDate"></div><div class="form-row"><label>åˆ†é¡</label><select id="txCat"><option>é¤é£²ç¾é£Ÿ</option><option>äº¤é€šå‡ºè¡Œ</option><option>è³¼ç‰©æ¶ˆè²»</option><option>å±…å®¶ç”Ÿæ´»</option><option>ä¼‘é–’å¨›æ¨‚</option><option>å…¶ä»–</option></select></div></div>
           <div class="form-row"><label>é …ç›®åç¨±</label><input type="text" id="txDesc" placeholder="é …ç›®æè¿°"></div>
           <div class="grid-2"><div class="form-row"><label>é‡‘é¡</label><input type="number" id="txAmt" oninput="recalc()"></div><div class="form-row"><label>å¡ç‰‡</label><select id="txCard" onchange="recalc()"><option value="UNIOPEN">ä¸­ä¿¡ Uniopen</option><option value="DBS">æ˜Ÿå±•å‚³èªªå°æ±º</option><option value="CUBE_L3">åœ‹æ³° CUBE</option><option value="OTHER">å…¶ä»–</option></select></div></div>
           <div class="grid-2"><div class="form-row"><label>æ”¯ä»˜æ–¹å¼</label><select id="txMethod" onchange="recalc()"><option value="PHYSICAL">å¯¦é«”/æ„Ÿæ‡‰</option><option value="ICASH_PAY">icash Pay (+4%)</option><option value="AUTO_LOAD">è‡ªå‹•åŠ å€¼</option></select></div><div class="form-row"><label>çµ±ä¸€å“ç‰Œ</label><select id="txBrand" onchange="recalc()"><option value="NONE">éçµ±ä¸€</option><option value="711">7-11</option><option value="starbucks">æ˜Ÿå·´å…‹</option><option value="carrefour">å®¶æ¨‚ç¦</option><option value="cosmed">åº·æ˜¯ç¾</option><option value="others">å…¶ä»–çµ±ä¸€</option></select></div></div>
           <div id="prePreview" style="background:#F9F9F9; padding:10px; border-radius:8px; font-size:0.9em; margin-top:10px;">é è¨ˆå›é¥‹ï¼š<span id="preTotal" style="font-weight:bold;">0</span><br><small id="preDetail" style="color:var(--sub);"></small></div>
           <button onclick="commitTx()" class="btn-main">ç¢ºèªè¨˜å¸³</button>
       </div>
   </div>

   <div id="sec-miles" class="section hidden">
       <div class="card"><h2>è³‡ç”¢åº«å­˜ (AM æ›ç®—)</h2><div id="assetSummary"></div></div>
       <div class="card">
           <h2>åº«å­˜èª¿æ•´</h2>
           <div class="grid-2"><select id="adjType"><option value="AM">AM</option><option value="DBS_PT">æ˜Ÿå±•</option><option value="CUBE_PT">å°æ¨¹é»</option><option value="OPEN_PT">OP</option></select><input type="number" id="adjVal" placeholder="+/-"></div>
           <button onclick="commitAdj()" class="btn-main" style="background:var(--secondary);">èª¿æ•´åº«å­˜</button>
       </div>
   </div>

   <div id="sec-history" class="section hidden">
       <div class="card">
           <h2>ç´€éŒ„èˆ‡å‚™ä»½</h2>
           <div class="grid-2">
               <button onclick="exportExcel()" style="background:#2ecc71; color:white; border:none; padding:10px; border-radius:8px;">åŒ¯å‡º Excel</button>
               <button onclick="document.getElementById('importFile').click()" style="background:#3498db; color:white; border:none; padding:10px; border-radius:8px;">åŒ¯å…¥ Excel</button>
               <input type="file" id="importFile" style="display:none;" onchange="importExcel(event)">
           </div>
           <div class="table-wrapper" style="margin-top:15px;"><table id="txTable"><thead><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>å›é¥‹</th><th>åˆª</th></tr></thead><tbody></tbody></table></div>
       </div>
   </div>

   <div id="sec-settings" class="section hidden">
       <div class="card">
           <h2>è¨­å®šç›®æ¨™èˆ‡æ¯”ä¾‹</h2>
           <div class="grid-2"><input type="text" id="setGoalName" placeholder="ç›®æ¨™åç¨±"><input type="number" id="setGoalTarget" placeholder="ç›®æ¨™ AM"></div>
           <div id="rateInputs" class="grid-2" style="margin-top:10px;"></div>
           <button onclick="saveSettings()" class="btn-main">å„²å­˜è¨­å®š</button>
       </div>
       <div class="card"><h2>æ”¯å‡ºä½”æ¯”</h2><canvas id="statChart"></canvas></div>
   </div>
</div>

<div class="nav-bar">
   <div class="nav-item active" onclick="nav('entry')">è¨˜å¸³</div>
   <div class="nav-item" onclick="nav('miles')">é‡Œç¨‹</div>
   <div class="nav-item" onclick="nav('history')">æ­·å²</div>
   <div class="nav-item" onclick="nav('settings')">è¨­å®š</div>
</div>

<script>
   let state = JSON.parse(localStorage.getItem('am_uni_final_v6')) || {
       records: [], adjusts: [], goal: { name: "é‡Œç¨‹ç›®æ¨™", target: 50000 },
       rates: { AM: 1, DBS_PT: 2, CUBE_PT: 0.36, OPEN_PT: 0.25 }
   };

   function getMonthStats() {
       const m = new Date().getMonth();
       const mRecs = state.records.filter(r => new Date(r.date).getMonth() === m);
       const brands = new Set(mRecs.filter(r => r.brand !== 'NONE').map(r => r.brand));
       const dbsSpent = mRecs.filter(r => r.cardKey === 'DBS').reduce((s, r) => s + r.amt, 0);
       const uniSpent = mRecs.filter(r => r.cardKey === 'UNIOPEN').reduce((s, r) => s + r.amt, 0);
       return { brandCount: brands.size, brands: Array.from(brands), dbsSpent, uniSpent };
   }

   function recalc() {
       const amt = parseFloat(document.getElementById('txAmt').value) || 0;
       const card = document.getElementById('txCard').value;
       const brand = document.getElementById('txBrand').value;
       const s = getMonthStats();
       if(card==='UNIOPEN') {
           let r = (s.brandCount >= 5 || (brand!=='NONE' && !s.brands.includes(brand) && s.brandCount+1 >= 5)) ? 0.07 : 0.03;
           if(document.getElementById('txMethod').value==='ICASH_PAY') r+=0.04;
           document.getElementById('preTotal').innerText = Math.round(amt*r) + " OP";
       } else if(card==='DBS') {
           let r = s.dbsSpent < 11363 ? 0.1 : 0.012;
           document.getElementById('preTotal').innerText = Math.round(amt*r*state.rates.DBS_PT) + " AM";
       }
   }

   function commitTx() {
       const amt = parseFloat(document.getElementById('txAmt').value);
       if(!amt) return;
       state.records.unshift({ id: Date.now(), date: document.getElementById('txDate').value, cat: document.getElementById('txCat').value, desc: document.getElementById('txDesc').value, amt, cardKey: document.getElementById('txCard').value, method: document.getElementById('txMethod').value, brand: document.getElementById('txBrand').value });
       save();
   }

   function commitAdj() {
       const val = parseFloat(document.getElementById('adjVal').value);
       if(!val) return;
       state.adjusts.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), type: document.getElementById('adjType').value, amt: val });
       save();
   }

   function refreshUI() {
       const s = getMonthStats();
       let totalAM = state.adjusts.reduce((sum, a) => sum + (a.amt * state.rates[a.type]), 0);
       state.records.forEach(r => {
           if(r.cardKey==='DBS') totalAM += (r.amt * 0.1 * state.rates.DBS_PT);
           else if(r.cardKey==='UNIOPEN') totalAM += (r.amt * (s.brandCount>=5?0.07:0.03) * state.rates.OPEN_PT);
       });
       document.getElementById('currentMilesDisp').innerText = Math.round(totalAM).toLocaleString();
       document.getElementById('targetMilesDisp').innerText = state.goal.target.toLocaleString();
       document.getElementById('goalBar').style.width = Math.min(100, (totalAM/state.goal.target)*100) + "%";
       document.getElementById('dbsSpentDisp').innerText = Math.round(s.dbsSpent).toLocaleString();
       document.getElementById('dbsBar').style.width = Math.min(100, (s.dbsSpent/11363)*100) + "%";
       document.getElementById('uniBar').style.width = Math.min(100, (s.uniSpent/12500)*100) + "%";
       document.getElementById('uniStatus').innerText = `${s.brandCount} å“ç‰Œ (${s.brandCount>=5?'7%+':'3%'})`;
       document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', s.brands.includes(c.dataset.brand)));
       renderHistory(s);
       renderAsset(totalAM);
   }

   function renderHistory(s) {
       document.querySelector('#txTable tbody').innerHTML = state.records.map(r => `
           <tr><td>${r.date.slice(5)}</td><td>${r.desc}</td><td>${r.cardKey==='UNIOPEN'?'OP':'AM'}</td><td><button onclick="delRec(${r.id})">âŒ</button></td></tr>
       `).join('');
   }

   function renderAsset(total) {
       document.getElementById('assetSummary').innerHTML = `<div class="stat-box"><span>é ä¼°ç¸½é‡Œç¨‹</span><span class="reward-am">${Math.round(total)} AM</span></div>`;
   }

   function exportExcel() {
       const ws = XLSX.utils.json_to_sheet(state.records);
       const wb = XLSX.utils.book_new();
       XLSX.utils.book_append_sheet(wb, ws, "Records");
       XLSX.writeFile(wb, "mileage_backup.xlsx");
   }

   function importExcel(e) {
       const reader = new FileReader();
       reader.onload = (f) => {
           const data = new Uint8Array(f.target.result);
           const workbook = XLSX.read(data, {type: 'array'});
           state.records = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
           save();
           location.reload();
       };
       reader.readAsArrayBuffer(e.target.files[0]);
   }

   function saveSettings() {
       state.goal.name = document.getElementById('setGoalName').value;
       state.goal.target = parseInt(document.getElementById('setGoalTarget').value);
       Object.keys(state.rates).forEach(k => state.rates[k] = parseFloat(document.getElementById('rate_'+k).value));
       save();
   }

   function nav(id) {
       document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
       document.getElementById('sec-' + id).classList.remove('hidden');
       document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
       event.currentTarget.classList.add('active');
       if(id==='settings') renderChart();
   }

   function renderChart() {
       const ctx = document.getElementById('statChart').getContext('2d');
       if(window.myChart) window.myChart.destroy();
       const data = ["é¤é£²ç¾é£Ÿ","äº¤é€šå‡ºè¡Œ","è³¼ç‰©æ¶ˆè²»","å±…å®¶ç”Ÿæ´»","ä¼‘é–’å¨›æ¨‚","å…¶ä»–"].map(c => state.records.reduce((sum, r) => r.cat===c?sum+r.amt:sum, 0));
       window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ["é¤é£²","äº¤é€š","è³¼ç‰©","å±…å®¶","ä¼‘é–’","å…¶ä»–"], datasets: [{ data, backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] }] }});
   }

   function save() { localStorage.setItem('am_uni_final_v6', JSON.stringify(state)); refreshUI(); }
   function delRec(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { state.records = state.records.filter(r=>r.id!==id); save(); } }

   document.getElementById('txDate').valueAsDate = new Date();
   document.getElementById('rateInputs').innerHTML = Object.keys(state.rates).map(k => `<div class="form-row"><label>${k} æ¯”ä¾‹</label><input type="number" step="0.01" id="rate_${k}" value="${state.rates[k]}"></div>`).join('');
   refreshUI();
</script>
</body>
</html>

