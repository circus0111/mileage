<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>AM é ˜èˆªå“¡ï¼šå…¨é»æ•¸ä¿®æ­£ç‰ˆ</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
   <style>
       :root { --primary: #5D8AA8; --secondary: #88B04B; --danger: #E07A5F; --uni: #FF8C00; --bg: #F4F7F6; --card: #FFFFFF; --text: #2C3E50; --sub: #7F8C8D; }
       body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 80px 15px; }
       .container { max-width: 900px; margin: 0 auto; }
       .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
       h2 { font-size: 1.1em; border-left: 4px solid var(--primary); padding-left: 10px; margin: 0 0 15px 0; }
       .monitor-card { border: 1px solid #D1E1EB; background: #F0F7FA; position: sticky; top: 0; z-index: 10; }
       .stat-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.85em; }
       .progress-container { background: #E0E0E0; border-radius: 10px; height: 10px; margin: 8px 0; overflow: hidden; }
       .progress-bar { height: 100%; transition: width 0.6s; background: var(--primary); }
       .brand-chips { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
       .chip { font-size: 0.65em; padding: 3px 8px; border-radius: 12px; background: #EEE; color: #999; border: 1px solid #DDD; }
       .chip.active { background: var(--uni); color: white; border-color: var(--uni); font-weight: bold; }
       .form-row { display: flex; flex-direction: column; margin-bottom: 12px; }
       label { font-size: 0.8em; color: var(--sub); margin-bottom: 4px; }
       input, select { padding: 10px; border: 1px solid #DDD; border-radius: 8px; font-size: 1em; }
       .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
       .btn-main { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; background: var(--primary); color: white; font-weight: bold; }
       .table-wrapper { overflow-x: auto; }
       table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
       th, td { padding: 12px 8px; border-bottom: 1px solid #EEE; text-align: left; }
       .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
       .nav-item { text-align: center; font-size: 0.8em; cursor: pointer; color: var(--sub); flex: 1; }
       .nav-item.active { color: var(--primary); font-weight: bold; }
       .hidden { display: none; }
   </style>
</head>
<body>

<div class="container">
   <div class="card monitor-card">
       <div class="stat-box">
           <span style="font-weight:bold;">âœˆï¸ <span id="goalNameDisp">é‡Œç¨‹ç›®æ¨™</span></span>
           <span style="color:var(--primary); font-weight:bold;"><span id="currentMilesDisp">0</span> / <span id="targetMilesDisp">0</span> AM</span>
       </div>
       <div class="progress-container"><div id="goalBar" class="progress-bar" style="background:var(--secondary);"></div></div>
       
       <div class="stat-box"><span>ğŸ’³ æ˜Ÿå±• 10% (ä¸Šé™ $11,363)</span><span>$<span id="dbsSpentDisp">0</span></span></div>
       <div class="progress-container"><div id="dbsBar" class="progress-bar"></div></div>
       
       <div class="stat-box" style="color:var(--uni); font-weight:bold;"><span>ğŸ¦ Uniopen ä»»å‹™ ($12,500)</span><span id="uniStatus">0 å“ç‰Œ</span></div>
       <div class="progress-container"><div id="uniBar" class="progress-bar" style="background:var(--uni);"></div></div>
       
       <div class="brand-chips" id="brandChips">
           <span class="chip" data-brand="711">7-11</span><span class="chip" data-brand="starbucks">æ˜Ÿå·´å…‹</span>
           <span class="chip" data-brand="carrefour">å®¶æ¨‚ç¦</span><span class="chip" data-brand="cosmed">åº·æ˜¯ç¾</span><span class="chip" data-brand="others">å…¶ä»–çµ±ä¸€</span>
       </div>
   </div>

   <div id="sec-entry" class="section">
       <div class="card">
           <h2>æ–°å¢æ¶ˆè²»</h2>
           <div class="grid-2"><div class="form-row"><label>æ—¥æœŸ</label><input type="date" id="txDate"></div><div class="form-row"><label>åˆ†é¡</label><select id="txCat"><option>é¤é£²ç¾é£Ÿ</option><option>äº¤é€šå‡ºè¡Œ</option><option>è³¼ç‰©æ¶ˆè²»</option><option>å±…å®¶ç”Ÿæ´»</option><option>ä¼‘é–’å¨›æ¨‚</option><option>å…¶ä»–</option></select></div></div>
           <div class="form-row"><label>é …ç›®åç¨±</label><input type="text" id="txDesc" placeholder="ä¾‹å¦‚ï¼šçµ±ä¸€è¶…å•†"></div>
           <div class="grid-2">
               <div class="form-row"><label>é‡‘é¡</label><input type="number" id="txAmt" oninput="recalc()"></div>
               <div class="form-row"><label>å¡ç‰‡</label><select id="txCard" onchange="recalc()"><option value="UNIOPEN">ä¸­ä¿¡ Uniopen</option><option value="DBS">æ˜Ÿå±•å‚³èªªå°æ±º</option><option value="CUBE_L3">åœ‹æ³° CUBE</option><option value="OTHER">å…¶ä»–</option></select></div>
           </div>
           <div class="grid-2">
               <div class="form-row"><label>æ”¯ä»˜æ–¹å¼</label><select id="txMethod" onchange="recalc()"><option value="PHYSICAL">å¯¦é«”/æ„Ÿæ‡‰</option><option value="ICASH_PAY">icash Pay (+4%)</option></select></div>
               <div class="form-row"><label>çµ±ä¸€å“ç‰Œ</label><select id="txBrand" onchange="recalc()"><option value="NONE">éçµ±ä¸€</option><option value="711">7-11</option><option value="starbucks">æ˜Ÿå·´å…‹</option><option value="carrefour">å®¶æ¨‚ç¦</option><option value="cosmed">åº·æ˜¯ç¾</option><option value="others">å…¶ä»–çµ±ä¸€</option></select></div>
           </div>
           <div id="prePreview" style="background:#F9F9F9; padding:12px; border-radius:8px; font-size:0.9em; margin-top:10px; border:1px dashed #DDD;">é è¨ˆå›é¥‹ï¼š<span id="preTotal">0</span></div>
           <button onclick="commitTx()" class="btn-main" style="margin-top:15px;">ç¢ºèªè¨˜å¸³</button>
       </div>
   </div>

   <div id="sec-miles" class="section hidden">
       <div class="card"><h2>é»æ•¸è³‡ç”¢åº«å­˜ (AM æ›ç®—)</h2><div id="assetSummary"></div></div>
       <div class="card">
           <h2>æ‰‹å‹•èª¿æ•´é»æ•¸</h2>
           <div class="grid-2">
               <select id="adjType">
                   <option value="AM">AM å¯¦é«”é‡Œç¨‹</option>
                   <option value="DBS_PT">æ˜Ÿå±•é»æ•¸</option>
                   <option value="OPEN_PT">OpenPoint</option>
                   <option value="HAMI_PT">HamiPoint</option>
                   <option value="HG_PT">HappyGo</option>
                   <option value="CUBE_PT">å°æ¨¹é»</option>
                   <option value="TS_PT">å°æ–°é»</option>
               </select>
               <input type="number" id="adjVal" placeholder="+/- é»æ•¸">
           </div>
           <button onclick="commitAdj()" class="btn-main" style="background:var(--secondary); margin-top:10px;">èª¿æ•´åº«å­˜</button>
       </div>
   </div>

   <div id="sec-history" class="section hidden">
       <div class="card">
           <h2>å‚™ä»½èˆ‡ç´€éŒ„</h2>
           <div class="grid-2">
               <button onclick="exportExcel()" style="background:#2ecc71; color:white; border:none; padding:10px; border-radius:8px;">åŒ¯å‡º</button>
               <button onclick="document.getElementById('importFile').click()" style="background:#3498db; color:white; border:none; padding:10px; border-radius:8px;">åŒ¯å…¥</button>
               <input type="file" id="importFile" style="display:none;" onchange="importExcel(event)">
           </div>
           <div class="table-wrapper" style="margin-top:20px;"><table id="txTable"><thead><tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th>é¡å‹</th><th>åˆª</th></tr></thead><tbody></tbody></table></div>
       </div>
   </div>

   <div id="sec-settings" class="section hidden">
       <div class="card">
           <h2>å…¨é»æ•¸æ¯”ä¾‹è¨­å®š (1é» = ? AM)</h2>
           <div class="grid-2"><input type="text" id="setGoalName"><input type="number" id="setGoalTarget"></div>
           <div id="rateInputs" class="grid-2" style="margin-top:10px;"></div>
           <button onclick="saveSettings()" class="btn-main" style="margin-top:15px;">å„²å­˜æ¯”ä¾‹è¨­å®š</button>
       </div>
       <button onclick="clearAll()" style="width:100%; color:var(--danger); background:none; border:1px solid var(--danger); padding:10px; border-radius:8px;">é‡ç½®è³‡æ–™</button>
   </div>
</div>

<div class="nav-bar">
   <div class="nav-item active" onclick="nav('entry')">è¨˜å¸³</div>
   <div class="nav-item" onclick="nav('miles')">é‡Œç¨‹</div>
   <div class="nav-item" onclick="nav('history')">æ­·å²</div>
   <div class="nav-item" onclick="nav('settings')">è¨­å®š</div>
</div>

<script>
   // 1. å®Œæ•´é»æ•¸é¡å‹åˆå§‹åŒ–
   let state = JSON.parse(localStorage.getItem('am_uni_v9_full')) || {
       records: [], 
       adjusts: [], 
       goal: { name: "é‡Œç¨‹ç›®æ¨™", target: 50000 },
       rates: { 
           AM: 1, 
           DBS_PT: 2, 
           OPEN_PT: 0.25, 
           HAMI_PT: 0.33, 
           HG_PT: 0.25, 
           CUBE_PT: 0.36, 
           TS_PT: 0.55 
       }
   };

   function getMonthStats() {
       const m = new Date().getMonth();
       const mRecs = state.records.filter(r => new Date(r.date).getMonth() === m);
       const brands = new Set(mRecs.filter(r => r.brand !== 'NONE').map(r => r.brand));
       return { brandCount: brands.size, brands: Array.from(brands), 
                dbsSpent: mRecs.filter(r => r.cardKey === 'DBS').reduce((sum, r) => sum + r.amt, 0),
                uniSpent: mRecs.filter(r => r.cardKey === 'UNIOPEN').reduce((sum, r) => sum + r.amt, 0) };
   }

   function calcTotalAM() {
       const s = getMonthStats();
       // åº«å­˜é»æ•¸æ›ç®—
       let total = state.adjusts.reduce((sum, a) => sum + (parseFloat(a.amt) * (state.rates[a.type] || 0)), 0);
       // æ¶ˆè²»ç´€éŒ„æ›ç®—
       state.records.forEach(r => {
           if(r.cardKey === 'DBS') total += (r.amt * (r.amt <= 11363 ? 0.1 : 0.012) * state.rates.DBS_PT);
           else if(r.cardKey === 'UNIOPEN') {
               let rate = (s.brandCount >= 5 ? 0.07 : 0.03) + (r.method === 'ICASH_PAY' ? 0.04 : 0);
               total += (r.amt * rate * state.rates.OPEN_PT);
           }
       });
       return total;
   }

   function refreshUI() {
       const s = getMonthStats();
       const totalAM = calcTotalAM();
       document.getElementById('currentMilesDisp').innerText = Math.round(totalAM).toLocaleString();
       document.getElementById('targetMilesDisp').innerText = state.goal.target.toLocaleString();
       document.getElementById('goalBar').style.width = Math.min(100, (totalAM/state.goal.target)*100) + "%";
       document.getElementById('dbsSpentDisp').innerText = Math.round(s.dbsSpent).toLocaleString();
       document.getElementById('dbsBar').style.width = Math.min(100, (s.dbsSpent/11363)*100) + "%";
       document.getElementById('uniBar').style.width = Math.min(100, (s.uniSpent/12500)*100) + "%";
       document.getElementById('uniStatus').innerText = `${s.brandCount} å“ç‰Œ`;
       document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', s.brands.includes(c.dataset.brand)));
       
       renderAsset();
       document.querySelector('#txTable tbody').innerHTML = state.records.map(r => `<tr><td>${r.date.slice(5)}</td><td>${r.desc}</td><td>${r.cardKey}</td><td><button onclick="delRec(${r.id})">âŒ</button></td></tr>`).join('');
   }

   function renderAsset() {
       document.getElementById('assetSummary').innerHTML = Object.entries(state.rates).map(([k,v]) => {
           let count = state.adjusts.filter(a=>a.type===k).reduce((sum,a)=>sum+parseFloat(a.amt), 0);
           return `<div class="stat-box" style="border-bottom:1px solid #EEE; padding:5px 0;"><span>${k}</span><span>${Math.round(count)} (â‰ˆ${Math.round(count*v)} AM)</span></div>`;
       }).join('');
   }

   function recalc() {
       const amt = parseFloat(document.getElementById('txAmt').value) || 0;
       const card = document.getElementById('txCard').value;
       const s = getMonthStats();
       let res = "";
       if(card==='UNIOPEN') res = "é è¨ˆ " + Math.round(amt*0.07) + " OP";
       else if(card==='DBS') res = "é è¨ˆ " + Math.round(amt*0.1*state.rates.DBS_PT) + " AM";
       document.getElementById('preTotal').innerText = res;
   }

   function commitTx() {
       state.records.unshift({ id: Date.now(), date: document.getElementById('txDate').value, cat: document.getElementById('txCat').value, desc: document.getElementById('txDesc').value, amt: parseFloat(document.getElementById('txAmt').value), cardKey: document.getElementById('txCard').value, method: document.getElementById('txMethod').value, brand: document.getElementById('txBrand').value });
       save();
   }

   function commitAdj() {
       state.adjusts.unshift({ id: Date.now(), type: document.getElementById('adjType').value, amt: parseFloat(document.getElementById('adjVal').value) });
       save();
   }

   function saveSettings() {
       state.goal.target = parseInt(document.getElementById('setGoalTarget').value);
       Object.keys(state.rates).forEach(k => state.rates[k] = parseFloat(document.getElementById('rate_'+k).value));
       save();
       alert("æ¯”ä¾‹å·²å„²å­˜");
   }

   function nav(id) {
       document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
       document.getElementById('sec-' + id).classList.remove('hidden');
       document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
       event.currentTarget.classList.add('active');
   }

   function exportExcel() {
       const ws = XLSX.utils.json_to_sheet(state.records);
       const wb = XLSX.utils.book_new();
       XLSX.utils.book_append_sheet(wb, ws, "Records");
       XLSX.writeFile(wb, "mileage_backup.xlsx");
   }

   function importExcel(e) {
       const reader = new FileReader();
       reader.onload = (f) => {
           state.records = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(f.target.result), {type: 'array'}).Sheets["Records"]);
           save(); location.reload();
       };
       reader.readAsArrayBuffer(e.target.files[0]);
   }

   function save() { localStorage.setItem('am_uni_v9_full', JSON.stringify(state)); refreshUI(); }
   function delRec(id) { state.records = state.records.filter(r=>r.id!==id); save(); }
   function clearAll() { localStorage.clear(); location.reload(); }

   document.getElementById('txDate').valueAsDate = new Date();
   document.getElementById('setGoalTarget').value = state.goal.target;
   document.getElementById('rateInputs').innerHTML = Object.keys(state.rates).map(k => `<div class="form-row"><label>${k} æ¯”ä¾‹</label><input type="number" step="0.01" id="rate_${k}" value="${state.rates[k]}"></div>`).join('');
   refreshUI();
</script>
</body>
</html>

